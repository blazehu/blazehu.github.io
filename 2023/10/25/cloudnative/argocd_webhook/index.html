<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>Argo CD 源码解析之自动同步 | 小千世界</title><meta name="description" content="Argo CD 的自动同步功能通过监控 Git 仓库中的更改来自动部署和更新应用程序。这确保了 Kubernetes 集群中的应用程序始终与 Git 仓库中的配置保持一致。开发团队只需将应用程序的描述和配置存储在 Git 仓库中，Argo CD 会根据这些信息自动部署和更新应用程序。"><meta property="og:type" content="article"><meta property="og:title" content="Argo CD 源码解析之自动同步"><meta property="og:url" content="https://blazehu.github.io/2023/10/25/cloudnative/argocd_webhook/index.html"><meta property="og:site_name" content="小千世界"><meta property="og:description" content="Argo CD 的自动同步功能通过监控 Git 仓库中的更改来自动部署和更新应用程序。这确保了 Kubernetes 集群中的应用程序始终与 Git 仓库中的配置保持一致。开发团队只需将应用程序的描述和配置存储在 Git 仓库中，Argo CD 会根据这些信息自动部署和更新应用程序。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://blazehu.github.io/2023/10/25/cloudnative/argocd_webhook/dependencies.png"><meta property="og:image" content="https://blazehu.github.io/2023/10/25/cloudnative/argocd_webhook/apiserver.png"><meta property="og:image" content="https://blazehu.github.io/2023/10/25/cloudnative/argocd_webhook/request.png"><meta property="article:published_time" content="2023-10-24T16:00:00.000Z"><meta property="article:modified_time" content="2024-02-19T08:54:22.951Z"><meta property="article:author" content="BlazeHu"><meta property="article:tag" content="k8s"><meta property="article:tag" content="gitops"><meta property="article:tag" content="argocd"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blazehu.github.io/2023/10/25/cloudnative/argocd_webhook/dependencies.png"><link rel="canonical" href="https://blazehu.github.io/2023/10/25/cloudnative/argocd_webhook/index.html"><link rel="alternate" href="/atom.xml" title="小千世界" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 4.2.1"></head><body class="main-center theme-green" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/blazehu" target="_blank"><img class="img-circle img-rotate" src="/images/avatar.png" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">blazehu</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">CloudNative/SRE/DevOps</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shanghai, China</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">分类</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">标签</span></a></li><li class="menu-item menu-item-links"><a href="/links"><i class="icon icon-friendship"></i> <span class="menu-title">友链</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">关于</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/blazehu" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><p>欢迎交流与分享经验!</p></div></div></div></div><div class="widget"><h3 class="widget-title">标签云</h3><div class="widget-body tagcloud"><a href="/tags/Protocol-Buffers/" style="font-size:13px">Protocol Buffers</a> <a href="/tags/archive-zip/" style="font-size:13px">archive/zip</a> <a href="/tags/argocd/" style="font-size:13.17px">argocd</a> <a href="/tags/aws/" style="font-size:13.17px">aws</a> <a href="/tags/docker/" style="font-size:13.17px">docker</a> <a href="/tags/fluxcd/" style="font-size:13px">fluxcd</a> <a href="/tags/g6/" style="font-size:13px">g6</a> <a href="/tags/gitops/" style="font-size:13.17px">gitops</a> <a href="/tags/grpc/" style="font-size:13px">grpc</a> <a href="/tags/helm/" style="font-size:13px">helm</a> <a href="/tags/iac/" style="font-size:13.67px">iac</a> <a href="/tags/ipapk/" style="font-size:13.17px">ipapk</a> <a href="/tags/k8s/" style="font-size:13.83px">k8s</a> <a href="/tags/kubebuilder/" style="font-size:13.33px">kubebuilder</a> <a href="/tags/leetcode/" style="font-size:14px">leetcode</a> <a href="/tags/mysql/" style="font-size:13.33px">mysql</a> <a href="/tags/nginx/" style="font-size:13.5px">nginx</a> <a href="/tags/perf/" style="font-size:13.17px">perf</a> <a href="/tags/pgsql/" style="font-size:13.33px">pgsql</a> <a href="/tags/rabbitmq/" style="font-size:13px">rabbitmq</a> <a href="/tags/sse/" style="font-size:13px">sse</a> <a href="/tags/ubuntu/" style="font-size:13.17px">ubuntu</a> <a href="/tags/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/" style="font-size:13.17px">函数式编程</a> <a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size:13.17px">正则表达式</a> <a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size:13px">消息队列</a> <a href="/tags/%E8%85%BE%E8%AE%AF%E4%BA%91/" style="font-size:13px">腾讯云</a> <a href="/tags/%E8%93%9D%E7%9B%BE/" style="font-size:13.17px">蓝盾</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size:13px">设计模式</a> <a href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" style="font-size:13px">负载均衡</a></div></div><div class="widget"><h3 class="widget-title">分类</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CloudNative/">CloudNative</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a><span class="category-list-count">7</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签</h3><div class="widget-body"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Protocol-Buffers/" rel="tag">Protocol Buffers</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/archive-zip/" rel="tag">archive/zip</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/argocd/" rel="tag">argocd</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aws/" rel="tag">aws</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fluxcd/" rel="tag">fluxcd</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/g6/" rel="tag">g6</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gitops/" rel="tag">gitops</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grpc/" rel="tag">grpc</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/helm/" rel="tag">helm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iac/" rel="tag">iac</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ipapk/" rel="tag">ipapk</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/" rel="tag">k8s</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubebuilder/" rel="tag">kubebuilder</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/" rel="tag">leetcode</a><span class="tag-list-count">32</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/perf/" rel="tag">perf</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pgsql/" rel="tag">pgsql</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rabbitmq/" rel="tag">rabbitmq</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sse/" rel="tag">sse</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/" rel="tag">函数式编程</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="tag">正则表达式</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" rel="tag">消息队列</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%85%BE%E8%AE%AF%E4%BA%91/" rel="tag">腾讯云</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%93%9D%E7%9B%BE/" rel="tag">蓝盾</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" rel="tag">负载均衡</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">二月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">十一月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">十月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">一月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">29</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a><span class="archive-list-count">5</span></li></ul></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Golang/">Golang</a></p><p class="item-title"><a href="/2024/02/18/golang/golang_archive_zip/" class="title">Golang archive/zip 问题排查小记</a></p><p class="item-date"><time datetime="2024-02-17T16:00:00.000Z" itemprop="datePublished">2024-02-18</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Golang/">Golang</a></p><p class="item-title"><a href="/2023/11/21/golang/golang_pb/" class="title">Protocol Buffers 学习笔记</a></p><p class="item-date"><time datetime="2023-11-20T16:00:00.000Z" itemprop="datePublished">2023-11-21</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/CloudNative/">CloudNative</a></p><p class="item-title"><a href="/2023/10/25/cloudnative/argocd_webhook/" class="title">Argo CD 源码解析之自动同步</a></p><p class="item-date"><time datetime="2023-10-24T16:00:00.000Z" itemprop="datePublished">2023-10-25</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2023/01/30/common/g6_tree_demo/" class="title">AntV G6 实现 k8s 资源拓扑图展示</a></p><p class="item-date"><time datetime="2023-01-29T16:00:00.000Z" itemprop="datePublished">2023-01-30</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2022/10/30/cloudnative/argocd_sse/" class="title">Argo CD 消息推送之 Server-Sent Events (SSE)</a></p><p class="item-date"><time datetime="2022-10-29T16:00:00.000Z" itemprop="datePublished">2022-10-30</time></p></div></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><nav id="toc" class="article-toc"><h3 class="toc-title">文章目录</h3><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-背景"><span class="toc-number">1.</span> <span class="toc-text">1.背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-源码解析"><span class="toc-number">2.</span> <span class="toc-text">2. 源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-main-go-入口函数"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 main.go 入口函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-argocd-server"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 argocd-server</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-1-ArgoCDWebhookHandler"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 ArgoCDWebhookHandler</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2-RefreshApp"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 RefreshApp</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-application-controller"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 application-controller</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-1-newApplicationInformerAndLister"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1 newApplicationInformerAndLister</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2-requestAppRefresh"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.2 requestAppRefresh</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-3-run"><span class="toc-number">2.3.3.</span> <span class="toc-text">2.3.3 run</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-4-processAppRefreshQueueItem"><span class="toc-number">2.3.4.</span> <span class="toc-text">2.3.4 processAppRefreshQueueItem</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-源码流程图"><span class="toc-number">3.</span> <span class="toc-text">3. 源码流程图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-总结"><span class="toc-number">4.</span> <span class="toc-text">4. 总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考文档"><span class="toc-number">5.</span> <span class="toc-text">参考文档</span></a></li></ol></nav></div></aside><main class="main" role="main"><div class="content"><article id="post-cloudnative/argocd_webhook" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">Argo CD 源码解析之自动同步</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2023/10/25/cloudnative/argocd_webhook/" class="article-date"><time datetime="2023-10-24T16:00:00.000Z" itemprop="datePublished">2023-10-25</time></a></span> <span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/CloudNative/">CloudNative</a></span> <span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link" href="/tags/argocd/" rel="tag">argocd</a>, <a class="article-tag-link" href="/tags/gitops/" rel="tag">gitops</a>, <a class="article-tag-link" href="/tags/k8s/" rel="tag">k8s</a></span> <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2023/10/25/cloudnative/argocd_webhook/#comments" class="article-comment-link">评论</a></span></div></div><div class="article-entry marked-body" itemprop="articleBody"><p>Argo CD 的自动同步功能通过监控 Git 仓库中的更改来自动部署和更新应用程序。这确保了 Kubernetes 集群中的应用程序始终与 Git 仓库中的配置保持一致。开发团队只需将应用程序的描述和配置存储在 Git 仓库中，Argo CD 会根据这些信息自动部署和更新应用程序。</p><a id="more"></a><h3 id="1-背景"><a href="#1-背景" class="headerlink" title="1.背景"></a>1.背景</h3><p>Argo CD 是一个开源的持续部署工具，专为 Kubernetes 应用程序设计。它遵循 GitOps 原则，将 Git 仓库作为应用程序部署和基础设施管理的“单一真实来源”。架构上 Argo CD 采用基于组件的架构设计，将不同可部署单元的职责分开，以提高系统的灵活性、可维护性和可扩展性。</p><p><img src="/2023/10/25/cloudnative/argocd_webhook/dependencies.png" alt="dependencies"></p><blockquote><p>有关架构的详细介绍可以阅读<a href="https://argo-cd.readthedocs.io/en/stable/developer-guide/architecture/components/" target="_blank" rel="noopener">这篇文档</a>。</p></blockquote><p>通过阅读 Argo CD 官方文档我们可以知道 Argo CD 每三分钟轮询一次 Git 存储库，以检测清单的更改。为了消除轮询延迟，Argo CD API server 支持 <a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/webhook/#1-create-the-webhook-in-the-git-provider" target="_blank" rel="noopener">配置 Git Webhook</a>。</p><h3 id="2-源码解析"><a href="#2-源码解析" class="headerlink" title="2. 源码解析"></a>2. 源码解析</h3><blockquote><p>本文的源码基于2.6.0版本</p></blockquote><h4 id="2-1-main-go-入口函数"><a href="#2-1-main-go-入口函数" class="headerlink" title="2.1 main.go 入口函数"></a>2.1 main.go 入口函数</h4><p>Argo CD 使用 <a href="https://github.com/spf13/cobra" target="_blank" rel="noopener">cobra</a> 来构建应用程序。通过 <code>cmd</code> 目录下的 <code>main.go</code> 入口函数，我们可以很轻易的找到每个组件。根据架构可知 API Server 是控制平面中的唯一入口。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">command = apiserver.NewCommand()</span><br></pre></td></tr></table></figure><h4 id="2-2-argocd-server"><a href="#2-2-argocd-server" class="headerlink" title="2.2 argocd-server"></a>2.2 argocd-server</h4><p>阅读 <code>ArgoCDServer</code> 实例的 <code>Run</code> 方法，可以发现 <code>ArgoCDServer</code> 使用 <a href="https://github.com/soheilhy/cmux" target="_blank" rel="noopener"><code>cmux</code></a> 库在多路复用，在同一端口上处理标准 HTTP 和 gRPC 请求。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">grpcS, appResourceTreeFn := a.newGRPCServer() </span><br><span class="line">grpcWebS := grpcweb.WrapServer(grpcS)</span><br><span class="line"><span class="comment">// 省略...</span></span><br><span class="line">httpS = a.newHTTPServer(ctx, a.ListenPort, grpcWebS, appResourceTreeFn, listeners.GatewayConn) </span><br><span class="line"></span><br><span class="line">tcpm := cmux.New(listeners.Main)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !a.useTLS() &#123;</span><br><span class="line">    httpL = tcpm.Match(cmux.HTTP1Fast())</span><br><span class="line">    grpcL = tcpm.MatchWithWriters(cmux.HTTP2MatchHeaderFieldSendSettings(<span class="string">"content-type"</span>, <span class="string">"application/grpc"</span>))</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="comment">// 省略...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; a.checkServeErr(<span class="string">"grpcS"</span>, grpcS.Serve(grpcL)) &#125;()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; a.checkServeErr(<span class="string">"httpS"</span>, httpS.Serve(httpL)) &#125;()</span><br></pre></td></tr></table></figure><p>我在官方文档上找到 Argo CD 中如何实现身份验证（authn）和授权（authz）的一张图，可以发现当我们通过 Web 页面或者 CLI 调用 apiserver 的时候首先经过 <code>cmux</code> 检查匹配，如果请求是 http1.x 将由 <code>http mux</code> 处理，如果是 http2 并且 <code>content-type: application/grpc</code> 则由 <code>grpc Server</code> 处理。</p><p><img src="/2023/10/25/cloudnative/argocd_webhook/apiserver.png" alt="apiserver"></p><blockquote><p>由于 Argo CD apiserver 绝大多数的 API 服务是通过 gRPC 实现的，所以这里引入了 gRPC Gateway 来将 gRPC 服务转换为 RESTful API。</p></blockquote><h5 id="2-2-1-ArgoCDWebhookHandler"><a href="#2-2-1-ArgoCDWebhookHandler" class="headerlink" title="2.2.1 ArgoCDWebhookHandler"></a>2.2.1 ArgoCDWebhookHandler</h5><p>从<a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/webhook/#1-create-the-webhook-in-the-git-provider" target="_blank" rel="noopener">配置 Git Webhook</a> 中找到 webhook events 的 endpoint 是 /api/webhook 。是走的 http1.x，我们查看 <code>ArgoCDServer</code> 实例的 <code>newHTTPServer</code> 方法，路径为 “/api/webhook” 的 HTTP 请求映射的是 <code>acdWebhookHandler.Handler</code>。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Webhook handler for git events (Note: cache timeouts are hardcoded because API server does not write to cache and not really using them)</span></span><br><span class="line">argoDB := db.NewDB(a.Namespace, a.settingsMgr, a.KubeClientset)</span><br><span class="line">acdWebhookHandler := webhook.NewHandler(a.Namespace, a.ArgoCDServerOpts.ApplicationNamespaces, a.AppClientset, a.settings, a.settingsMgr, repocache.NewCache(a.Cache.GetCache(), <span class="number">24</span>*time.Hour, <span class="number">3</span>*time.Minute), a.Cache, argoDB)</span><br><span class="line"></span><br><span class="line">mux.HandleFunc(<span class="string">"/api/webhook"</span>, acdWebhookHandler.Handler)</span><br></pre></td></tr></table></figure><p>继续往下看 <code>ArgoCDWebhookHandler</code> 的 <code>Handle</code> 方法的具体实现，根据请求的 Header 解析得到不同 Git 服务提供商的 Git 事件的数据，然后交给 <code>HandleEvent</code> 方法来处理，<code>HandleEvent</code> 经过一系列的校验检查后执行 <code>RefreshApp</code> 刷新应用。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// HandleEvent handles webhook events for repo push events</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *ArgoCDWebhookHandler)</span> <span class="title">HandleEvent</span><span class="params">(payload <span class="keyword">interface</span>&#123;&#125;)</span></span></span><br></pre></td></tr></table></figure><h5 id="2-2-2-RefreshApp"><a href="#2-2-2-RefreshApp" class="headerlink" title="2.2.2 RefreshApp"></a>2.2.2 RefreshApp</h5><p>注释写的很清楚，<code>RefreshApp</code> 通过更新应用的注解，强制控制器处理它。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// RefreshApp updates the refresh annotation of an application to coerce the controller to process it</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RefreshApp</span><span class="params">(appIf v1alpha1.ApplicationInterface, name <span class="keyword">string</span>, refreshType argoappv1.RefreshType)</span> <span class="params">(*argoappv1.Application, error)</span></span> &#123;</span><br><span class="line">	metadata := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">		<span class="string">"metadata"</span>: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">			<span class="string">"annotations"</span>: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line">				argoappv1.AnnotationKeyRefresh: <span class="keyword">string</span>(refreshType),</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	patch, err := json.Marshal(metadata)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"error marshaling metadata: %w"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> attempt := <span class="number">0</span>; attempt &lt; <span class="number">5</span>; attempt++ &#123;</span><br><span class="line">		app, err := appIf.Patch(context.Background(), name, types.MergePatchType, patch, metav1.PatchOptions&#123;&#125;)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> !apierr.IsConflict(err) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"error patching annotations in application %q: %w"</span>, name, err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			log.Infof(<span class="string">"Requested app '%s' refresh"</span>, name)</span><br><span class="line">			<span class="keyword">return</span> app, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		time.Sleep(<span class="number">100</span> * time.Millisecond)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-application-controller"><a href="#2-3-application-controller" class="headerlink" title="2.3 application-controller"></a>2.3 application-controller</h4><p>沿着之前的路径，从入口函数找到应用控制器的实现，appcontroller 中定义了默认的同步周期为180s。控制器通过 <code>newApplicationInformerAndLister</code> 创建 <code>ApplicationInformer</code> 监听应用的事件并加入到队列中。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	<span class="comment">// Default time in seconds for application resync period</span></span><br><span class="line">	defaultAppResyncPeriod = <span class="number">180</span></span><br><span class="line">)</span><br><span class="line"><span class="comment">// 省略...</span></span><br><span class="line">resyncDuration = time.Duration(appResyncPeriod) * time.Second</span><br><span class="line"><span class="comment">// 省略...</span></span><br><span class="line">appController, err = controller.NewApplicationController(</span><br><span class="line">    namespace,</span><br><span class="line">    settingsMgr,</span><br><span class="line">    kubeClient,</span><br><span class="line">    appClient,</span><br><span class="line">    repoClientset,</span><br><span class="line">    cache,</span><br><span class="line">    kubectl,</span><br><span class="line">    resyncDuration,</span><br><span class="line">    hardResyncDuration,</span><br><span class="line">    time.Duration(selfHealTimeoutSeconds)*time.Second,</span><br><span class="line">    metricsPort,</span><br><span class="line">    metricsCacheExpiration,</span><br><span class="line">    metricsAplicationLabels,</span><br><span class="line">    kubectlParallelismLimit,</span><br><span class="line">    persistResourceHealth,</span><br><span class="line">    clusterFilter,</span><br><span class="line">    applicationNamespaces)</span><br><span class="line"><span class="comment">// 省略...</span></span><br><span class="line"><span class="keyword">go</span> appController.Run(ctx, statusProcessors, operationProcessors)</span><br></pre></td></tr></table></figure><h5 id="2-3-1-newApplicationInformerAndLister"><a href="#2-3-1-newApplicationInformerAndLister" class="headerlink" title="2.3.1 newApplicationInformerAndLister"></a>2.3.1 newApplicationInformerAndLister</h5><p>上文中 <code>RefreshApp</code> 更新应用的注解将会产生一个 Update Event，将会走到 <code>requestAppRefresh</code> 。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">informer.AddEventHandler(</span><br><span class="line">    cache.ResourceEventHandlerFuncs&#123;</span><br><span class="line">        AddFunc: <span class="function"><span class="keyword">func</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> !ctrl.canProcessApp(obj) &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            key, err := cache.MetaNamespaceKeyFunc(obj)</span><br><span class="line">            <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">                ctrl.appRefreshQueue.Add(key)</span><br><span class="line">                ctrl.appOperationQueue.Add(key)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        UpdateFunc: <span class="function"><span class="keyword">func</span><span class="params">(old, <span class="built_in">new</span> <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> !ctrl.canProcessApp(<span class="built_in">new</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            key, err := cache.MetaNamespaceKeyFunc(<span class="built_in">new</span>)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> compareWith *CompareWith</span><br><span class="line">            oldApp, oldOK := old.(*appv1.Application)</span><br><span class="line">            newApp, newOK := <span class="built_in">new</span>.(*appv1.Application)</span><br><span class="line">            <span class="keyword">if</span> oldOK &amp;&amp; newOK &amp;&amp; automatedSyncEnabled(oldApp, newApp) &#123;</span><br><span class="line">                log.WithField(<span class="string">"application"</span>, newApp.QualifiedName()).Info(<span class="string">"Enabled automated sync"</span>)</span><br><span class="line">                compareWith = CompareWithLatest.Pointer()</span><br><span class="line">            &#125;</span><br><span class="line">            ctrl.requestAppRefresh(newApp.QualifiedName(), compareWith, <span class="literal">nil</span>)</span><br><span class="line">            ctrl.appOperationQueue.Add(key)</span><br><span class="line">        &#125;,</span><br><span class="line">        DeleteFunc: <span class="function"><span class="keyword">func</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> !ctrl.canProcessApp(obj) &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// IndexerInformer uses a delta queue, therefore for deletes we have to use this</span></span><br><span class="line">            <span class="comment">// key function.</span></span><br><span class="line">            key, err := cache.DeletionHandlingMetaNamespaceKeyFunc(obj)</span><br><span class="line">            <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">                ctrl.appRefreshQueue.Add(key)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h5 id="2-3-2-requestAppRefresh"><a href="#2-3-2-requestAppRefresh" class="headerlink" title="2.3.2 requestAppRefresh"></a>2.3.2 requestAppRefresh</h5><p><code>compareWith</code> 是 <code>CompareWithLatest</code>， <code>after</code> 是 <code>nil</code>。requestAppRefresh 方法将会在 <code>appRefreshQueue</code> 和 <code>appOperationQueue</code> 队列中添加该更新事件。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// requestAppRefresh adds a request for given app to the refresh queue. appName</span></span><br><span class="line"><span class="comment">// needs to be the qualified name of the application, i.e. &lt;namespace&gt;/&lt;name&gt;.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ctrl *ApplicationController)</span> <span class="title">requestAppRefresh</span><span class="params">(appName <span class="keyword">string</span>, compareWith *CompareWith, after *time.Duration)</span></span> &#123;</span><br><span class="line">	key := ctrl.toAppKey(appName)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> compareWith != <span class="literal">nil</span> &amp;&amp; after != <span class="literal">nil</span> &#123;</span><br><span class="line">		ctrl.appComparisonTypeRefreshQueue.AddAfter(fmt.Sprintf(<span class="string">"%s/%d"</span>, key, compareWith), *after)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> compareWith != <span class="literal">nil</span> &#123;</span><br><span class="line">			ctrl.refreshRequestedAppsMutex.Lock()</span><br><span class="line">			ctrl.refreshRequestedApps[key] = compareWith.Max(ctrl.refreshRequestedApps[key])</span><br><span class="line">			ctrl.refreshRequestedAppsMutex.Unlock()</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> after != <span class="literal">nil</span> &#123;</span><br><span class="line">			ctrl.appRefreshQueue.AddAfter(key, *after)</span><br><span class="line">			ctrl.appOperationQueue.AddAfter(key, *after)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			ctrl.appRefreshQueue.Add(key)</span><br><span class="line">			ctrl.appOperationQueue.Add(key)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-3-3-run"><a href="#2-3-3-run" class="headerlink" title="2.3.3 run"></a>2.3.3 run</h5><p>控制器使用两个单独的队列来处理应用的协调（<code>appRefreshQueue</code>）和同步（<code>appOperationQueue</code>），这两个队列分别通过 <code>processAppRefreshQueueItem</code> 和 <code>processAppOperationQueueItem</code> 来处理。</p><blockquote><p><code>statusProcessors</code> 和 <code>operationProcessors</code> 来控制启动协程的数量。</p></blockquote><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Run starts the Application CRD controller.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ctrl *ApplicationController)</span> <span class="title">Run</span><span class="params">(ctx context.Context, statusProcessors <span class="keyword">int</span>, operationProcessors <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> runtime.HandleCrash()</span><br><span class="line">	<span class="keyword">defer</span> ctrl.appRefreshQueue.ShutDown()</span><br><span class="line">	<span class="keyword">defer</span> ctrl.appComparisonTypeRefreshQueue.ShutDown()</span><br><span class="line">	<span class="keyword">defer</span> ctrl.appOperationQueue.ShutDown()</span><br><span class="line">	<span class="keyword">defer</span> ctrl.projectRefreshQueue.ShutDown()</span><br><span class="line"></span><br><span class="line">	ctrl.metricsServer.RegisterClustersInfoSource(ctx, ctrl.stateCache)</span><br><span class="line">	ctrl.RegisterClusterSecretUpdater(ctx)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> ctrl.appInformer.Run(ctx.Done())</span><br><span class="line">	<span class="keyword">go</span> ctrl.projInformer.Run(ctx.Done())</span><br><span class="line"></span><br><span class="line">	errors.CheckError(ctrl.stateCache.Init())</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !cache.WaitForCacheSync(ctx.Done(), ctrl.appInformer.HasSynced, ctrl.projInformer.HasSynced) &#123;</span><br><span class="line">		log.Error(<span class="string">"Timed out waiting for caches to sync"</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; errors.CheckError(ctrl.stateCache.Run(ctx)) &#125;()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; errors.CheckError(ctrl.metricsServer.ListenAndServe()) &#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; statusProcessors; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> wait.Until(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="keyword">for</span> ctrl.processAppRefreshQueueItem() &#123;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;, time.Second, ctx.Done())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; operationProcessors; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> wait.Until(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="keyword">for</span> ctrl.processAppOperationQueueItem() &#123;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;, time.Second, ctx.Done())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> wait.Until(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> ctrl.processAppComparisonTypeQueueItem() &#123;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;, time.Second, ctx.Done())</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> wait.Until(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> ctrl.processProjectQueueItem() &#123;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;, time.Second, ctx.Done())</span><br><span class="line">	&lt;-ctx.Done()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-3-4-processAppRefreshQueueItem"><a href="#2-3-4-processAppRefreshQueueItem" class="headerlink" title="2.3.4 processAppRefreshQueueItem"></a>2.3.4 processAppRefreshQueueItem</h5><p>从 <code>appRefreshQueue</code> 获取到上文中更新注解的事件后调用 <code>needRefreshAppStatus</code>，<code>needRefresh, refreshType, comparisonLevel = true, RefreshTypeNormal, CompareWithLatestForceResolve</code>。然后通过 <code>CompareAppState</code> 使用指定的版本和提供的源来比较应用程序 git 状态与实时应用程序状态。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">appKey, shutdown := ctrl.appRefreshQueue.Get()</span><br><span class="line"></span><br><span class="line">obj, exists, err := ctrl.appInformer.GetIndexer().GetByKey(appKey.(<span class="keyword">string</span>))</span><br><span class="line"></span><br><span class="line">origApp, ok := obj.(*appv1.Application)</span><br><span class="line"></span><br><span class="line">needRefresh, refreshType, comparisonLevel := ctrl.needRefreshAppStatus(origApp, ctrl.statusRefreshTimeout, ctrl.statusHardRefreshTimeout)</span><br><span class="line"></span><br><span class="line">compareResult := ctrl.appStateManager.CompareAppState(app, project, revisions, sources,</span><br><span class="line">    refreshType == appv1.RefreshTypeHard,</span><br><span class="line">    comparisonLevel == CompareWithLatestForceResolve, localManifests, hasMultipleSources)</span><br></pre></td></tr></table></figure><blockquote><p>上文提到的三分钟定时轮训也是在 needRefreshAppStatus 中实现。</p></blockquote><p><code>CompareAppState</code> 方法中会调用 <code>appStateManager</code> 实例的 <code>getRepoObjs</code> 来获取 Git 仓库中渲染出的清单文件。<code>getRepoObjs</code> 通过 gRPC 调用 reposerver 的 <code>GenerateManifest</code> 方法获取渲染出的清单文件。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AppStateManager defines methods which allow to compare application spec and actual application state.</span></span><br><span class="line"><span class="keyword">type</span> AppStateManager <span class="keyword">interface</span> &#123;</span><br><span class="line">	CompareAppState(app *v1alpha1.Application, project *appv1.AppProject, revisions []<span class="keyword">string</span>, sources []v1alpha1.ApplicationSource, noCache <span class="keyword">bool</span>, noRevisionCache <span class="keyword">bool</span>, localObjects []<span class="keyword">string</span>, hasMultipleSources <span class="keyword">bool</span>) *comparisonResult</span><br><span class="line">	SyncAppState(app *v1alpha1.Application, state *v1alpha1.OperationState)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// repoClientset 初始化后层层传递至 `AppStateManager` 实例中</span></span><br><span class="line">repoClientset := apiclient.NewRepoServerClientset(repoServerAddress, repoServerTimeoutSeconds, tlsConfig)</span><br><span class="line"></span><br><span class="line"><span class="comment">// getRepoObjs 通过 gRPC 调用 reposerver 的 GenerateManifest 方法</span></span><br><span class="line">manifestInfo, err := repoClient.GenerateManifest(context.Background(), &amp;apiclient.ManifestRequest&#123;</span><br><span class="line">    Repo:               repo,</span><br><span class="line">    Repos:              permittedHelmRepos,</span><br><span class="line">    Revision:           revisions[i],</span><br><span class="line">    NoCache:            noCache,</span><br><span class="line">    NoRevisionCache:    noRevisionCache,</span><br><span class="line">    AppLabelKey:        appLabelKey,</span><br><span class="line">    AppName:            app.InstanceName(m.namespace),</span><br><span class="line">    Namespace:          app.Spec.Destination.Namespace,</span><br><span class="line">    ApplicationSource:  &amp;source,</span><br><span class="line">    Plugins:            tools,</span><br><span class="line">    KustomizeOptions:   kustomizeOptions,</span><br><span class="line">    KubeVersion:        serverVersion,</span><br><span class="line">    ApiVersions:        argo.APIResourcesToStrings(apiResources, <span class="literal">true</span>),</span><br><span class="line">    VerifySignature:    verifySignature,</span><br><span class="line">    HelmRepoCreds:      permittedHelmCredentials,</span><br><span class="line">    TrackingMethod:     <span class="keyword">string</span>(argo.GetTrackingMethod(m.settingsMgr)),</span><br><span class="line">    EnabledSourceTypes: enabledSourceTypes,</span><br><span class="line">    HelmOptions:        helmOptions,</span><br><span class="line">    HasMultipleSources: app.Spec.HasMultipleSources(),</span><br><span class="line">    RefSources:         refSources,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>得到 <code>compareResult</code> 后会调用 <code>autoSync</code> 方法，如果应用开启了自动同步，将会更新 <code>Application</code> 的 <code>Operation</code> ，来启动同步操作。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// autoSync will initiate a sync operation for an application configured with automated sync</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ctrl *ApplicationController)</span> <span class="title">autoSync</span><span class="params">(app *appv1.Application, syncStatus *appv1.SyncStatus, resources []appv1.ResourceStatus)</span> *<span class="title">appv1</span>.<span class="title">ApplicationCondition</span></span></span><br></pre></td></tr></table></figure><p><code>processAppRefreshQueueItem</code> 最后将会调用 <code>persistAppStatus</code> 方法用于持久化，通过调用 k8s api 更新 applicaition 的 status。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// persistAppStatus persists updates to application status. If no changes were made, it is a no-op</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ctrl *ApplicationController)</span> <span class="title">persistAppStatus</span><span class="params">(orig *appv1.Application, newStatus *appv1.ApplicationStatus)</span></span> </span><br><span class="line"><span class="string">``</span><span class="string">` </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">##### 2.3.5 processAppOperationQueueItem</span></span><br><span class="line"><span class="string">跟 `</span>processAppRefreshQueueItem<span class="string">` 类似，从 `</span>appOperationQueue<span class="string">` 队列中拿到待执行同步操作的应用实例，判断该应用的 `</span>Operation<span class="string">` 字段是否为空，如果不为空则执行 `</span>processRequestedAppOperation<span class="string">`。`</span>processRequestedAppOperation<span class="string">` 也会进行一些状态校验，比如是否正在同步中等，最终应用下资源的同步将由 `</span>appStateManager<span class="string">` 实例的 `</span>SyncAppState<span class="string">` 实现。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span><span class="keyword">go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ctrl *ApplicationController)</span> <span class="title">processRequestedAppOperation</span><span class="params">(app *appv1.Application)</span></span> &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> err := argo.ValidateDestination(context.Background(), &amp;app.Spec.Destination, ctrl.db); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		state.Phase = synccommon.OperationFailed</span><br><span class="line">		state.Message = err.Error()</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		ctrl.appStateManager.SyncAppState(app, state)</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *appStateManager)</span> <span class="title">SyncAppState</span><span class="params">(app *v1alpha1.Application, state *v1alpha1.OperationState)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Sync requests might be requested with ambiguous revisions (e.g. master, HEAD, v1.2.3).</span></span><br><span class="line">	<span class="comment">// This can change meaning when resuming operations (e.g a hook sync). After calculating a</span></span><br><span class="line">	<span class="comment">// concrete git commit SHA, the SHA is remembered in the status.operationState.syncResult field.</span></span><br><span class="line">	<span class="comment">// This ensures that when resuming an operation, we sync to the same revision that we initially</span></span><br><span class="line">	<span class="comment">// started with.</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line">    syncCtx, cleanup, err := sync.NewSyncContext(</span><br><span class="line">		compareResult.syncStatus.Revision,</span><br><span class="line">		reconciliationResult,</span><br><span class="line">		restConfig,</span><br><span class="line">		rawConfig,</span><br><span class="line">		m.kubectl,</span><br><span class="line">		app.Spec.Destination.Namespace,</span><br><span class="line">		openAPISchema,</span><br><span class="line">		opts...,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		state.Phase = common.OperationError</span><br><span class="line">		state.Message = fmt.Sprintf(<span class="string">"failed to initialize sync context: %v"</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">defer</span> cleanup()</span><br><span class="line"></span><br><span class="line">	start := time.Now()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> state.Phase == common.OperationTerminating &#123;</span><br><span class="line">		syncCtx.Terminate()</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		syncCtx.Sync()</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://github.com/argoproj/argo-cd/blob/6e2f2c9d1e2339b3361f3a057747fcfe30e36f44/controller/sync.go#L296" target="_blank" rel="noopener"><code>syncCtx</code></a> 我们这里看接口定义大致了解即可，具体实现这里就不再展开了。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SyncContext defines an interface that allows to execute sync operation step or terminate it.</span></span><br><span class="line"><span class="keyword">type</span> SyncContext <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Terminate terminates sync operation. The method is asynchronous: it starts deletion is related K8S resources</span></span><br><span class="line">	<span class="comment">// such as in-flight resource hooks, updates operation status, and exists without waiting for resource completion.</span></span><br><span class="line">	Terminate()</span><br><span class="line">	<span class="comment">// Executes next synchronization step and updates operation status.</span></span><br><span class="line">	Sync()</span><br><span class="line">	<span class="comment">// Returns current sync operation state and information about resources synchronized so far.</span></span><br><span class="line">	GetState() (common.OperationPhase, <span class="keyword">string</span>, []common.ResourceSyncResult)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>这里的 <a href="https://github.com/argoproj/gitops-engine/blob/master/pkg/sync/sync_context.go" target="_blank" rel="noopener">SyncContext</a> 是由 <code>gitops-engine</code> 库实现。</p></blockquote><h3 id="3-源码流程图"><a href="#3-源码流程图" class="headerlink" title="3. 源码流程图"></a>3. 源码流程图</h3><p><img src="/2023/10/25/cloudnative/argocd_webhook/request.png" alt="request"></p><h3 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h3><p>自动同步是 Argo CD 的核心功能，了解其底层实现原理和源码有助于拓展技术视野，深入理解 Argo CD 的工作原理，并在遇到问题时提供解决方案。</p><h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><ul><li><a href="https://argo-cd.readthedocs.io/en/stable/developer-guide/architecture/components/" target="_blank" rel="noopener">https://argo-cd.readthedocs.io/en/stable/developer-guide/architecture/components/</a></li><li><a href="https://argo-cd.readthedocs.io/en/stable/developer-guide/architecture/authz-authn/" target="_blank" rel="noopener">https://argo-cd.readthedocs.io/en/stable/developer-guide/architecture/authz-authn/</a></li><li><a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/webhook/" target="_blank" rel="noopener">https://argo-cd.readthedocs.io/en/stable/operator-manual/webhook/</a></li><li><a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/high_availability/" target="_blank" rel="noopener">https://argo-cd.readthedocs.io/en/stable/operator-manual/high_availability/</a></li></ul></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="https://blazehu.github.io/2023/10/25/cloudnative/argocd_webhook/" title="Argo CD 源码解析之自动同步" target="_blank" rel="external">https://blazehu.github.io/2023/10/25/cloudnative/argocd_webhook/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://github.com/blazehu" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/avatar.png" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="https://github.com/blazehu" target="_blank"><span class="text-dark">blazehu</span><small class="ml-1x">CloudNative/SRE/DevOps</small></a></h3><div>个人简介。</div></div></figure></div></div></div></article><section id="comments"><div id="vcomments"></div></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2023/11/21/golang/golang_pb/" title="Protocol Buffers 学习笔记"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a></li><li class="next"><a href="/2023/01/30/common/g6_tree_demo/" title="AntV G6 实现 k8s 资源拓扑图展示"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li><li class="toggle-toc"><a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button"><span>[&nbsp;</span><span>文章目录</span> <i class="text-collapsed icon icon-anchor"></i> <i class="text-in icon icon-close"></i> <span>]</span></a></li></ul><button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div></div></div></nav><div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content donate"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><div class="modal-body"><div class="donate-box"><div class="donate-head"><p>感谢您的支持，我会继续努力的!</p></div><div class="tab-content"><div role="tabpanel" class="tab-pane fade active in" id="alipay"><div class="donate-payimg"><img src="/images/blazehu/alipayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p></div><div role="tabpanel" class="tab-pane fade" id="wechatpay"><div class="donate-payimg"><img src="/images/blazehu/wechatpayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p></div></div><div class="donate-footer"><ul class="nav nav-tabs nav-justified" role="tablist"><li role="presentation" class="active"><a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a></li><li role="presentation"><a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a></li></ul></div></div></div></div></div></div></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/blazehu" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div class="copyright"><div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine"></script><script type="text/javascript">var GUEST=["nick","mail","link"],meta=(meta="nick,mail,link").split(",").filter(function(e){return-1<GUEST.indexOf(e)});new Valine({el:"#vcomments",verify:!1,notify:!1,appId:"kXQOrkmTyCVLtqQoMTpVJPWK-gzGzoHsz",appKey:"yEbFaNQxvOxdDX4N65dhbrkq",placeholder:"Just go go",avatar:"mm",meta:meta,pageSize:"10",visitor:!1})</script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px;z-index:2}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>addLoadEvent(()=>{$(".highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code")[0].innerText;e+="",e+=`————————————————
`,e+=`本文链接：${window.location.href}
`,e+="版权声明： 本博客所有文章除特别声明外，均采用 CC BY 4.0 CN协议 许可协议。转载请注明出处！";var n=document.createElement("textarea");document.body.appendChild(n),n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.value=e,n.select(),n.focus(),e=document.execCommand("copy"),document.body.removeChild(n),e?$(this).text("复制成功"):$(this).text("复制失败"),$(this).blur()})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})})</script></body></html>