<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>Terraform Plugin Development | 小千世界</title><meta name="description" content="Terraform is an open source resource orchestration tool based on Golang, which allows users to manage and configure any infrastructure, the infrastructure of public and private cloud services, and ext"><meta property="og:type" content="article"><meta property="og:title" content="Terraform Plugin Development"><meta property="og:url" content="https://blazehu.github.io/2021/12/29/cloudnative/terraform-plugins/index.html"><meta property="og:site_name" content="小千世界"><meta property="og:description" content="Terraform is an open source resource orchestration tool based on Golang, which allows users to manage and configure any infrastructure, the infrastructure of public and private cloud services, and ext"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://blazehu.github.io/2021/12/29/cloudnative/terraform-plugins/terraform-plugin-overview.png"><meta property="article:published_time" content="2021-12-28T16:00:00.000Z"><meta property="article:modified_time" content="2022-08-10T08:48:14.714Z"><meta property="article:author" content="BlazeHu"><meta property="article:tag" content="iac"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blazehu.github.io/2021/12/29/cloudnative/terraform-plugins/terraform-plugin-overview.png"><link rel="canonical" href="https://blazehu.github.io/2021/12/29/cloudnative/terraform-plugins/index.html"><link rel="alternate" href="/atom.xml" title="小千世界" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 4.2.1"></head><body class="main-center theme-green" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/blazehu" target="_blank"><img class="img-circle img-rotate" src="/images/avatar.png" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">blazehu</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">CloudNative/SRE/DevOps</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shanghai, China</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">分类</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">标签</span></a></li><li class="menu-item menu-item-links"><a href="/links"><i class="icon icon-friendship"></i> <span class="menu-title">友链</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">关于</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/blazehu" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><p>欢迎交流与分享经验!</p></div></div></div></div><div class="widget"><h3 class="widget-title">标签云</h3><div class="widget-body tagcloud"><a href="/tags/Protocol-Buffers/" style="font-size:13px">Protocol Buffers</a> <a href="/tags/archive-zip/" style="font-size:13px">archive/zip</a> <a href="/tags/argocd/" style="font-size:13.17px">argocd</a> <a href="/tags/aws/" style="font-size:13.17px">aws</a> <a href="/tags/docker/" style="font-size:13.17px">docker</a> <a href="/tags/fluxcd/" style="font-size:13px">fluxcd</a> <a href="/tags/g6/" style="font-size:13px">g6</a> <a href="/tags/gitops/" style="font-size:13.17px">gitops</a> <a href="/tags/grpc/" style="font-size:13px">grpc</a> <a href="/tags/helm/" style="font-size:13px">helm</a> <a href="/tags/iac/" style="font-size:13.67px">iac</a> <a href="/tags/ipapk/" style="font-size:13.17px">ipapk</a> <a href="/tags/k8s/" style="font-size:13.83px">k8s</a> <a href="/tags/kubebuilder/" style="font-size:13.33px">kubebuilder</a> <a href="/tags/leetcode/" style="font-size:14px">leetcode</a> <a href="/tags/mysql/" style="font-size:13.33px">mysql</a> <a href="/tags/nginx/" style="font-size:13.5px">nginx</a> <a href="/tags/perf/" style="font-size:13.17px">perf</a> <a href="/tags/pgsql/" style="font-size:13.33px">pgsql</a> <a href="/tags/rabbitmq/" style="font-size:13px">rabbitmq</a> <a href="/tags/sse/" style="font-size:13px">sse</a> <a href="/tags/ubuntu/" style="font-size:13.17px">ubuntu</a> <a href="/tags/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/" style="font-size:13.17px">函数式编程</a> <a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size:13.17px">正则表达式</a> <a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size:13px">消息队列</a> <a href="/tags/%E8%85%BE%E8%AE%AF%E4%BA%91/" style="font-size:13px">腾讯云</a> <a href="/tags/%E8%93%9D%E7%9B%BE/" style="font-size:13.17px">蓝盾</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size:13px">设计模式</a> <a href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" style="font-size:13px">负载均衡</a></div></div><div class="widget"><h3 class="widget-title">分类</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CloudNative/">CloudNative</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a><span class="category-list-count">7</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签</h3><div class="widget-body"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Protocol-Buffers/" rel="tag">Protocol Buffers</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/archive-zip/" rel="tag">archive/zip</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/argocd/" rel="tag">argocd</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aws/" rel="tag">aws</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fluxcd/" rel="tag">fluxcd</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/g6/" rel="tag">g6</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gitops/" rel="tag">gitops</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grpc/" rel="tag">grpc</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/helm/" rel="tag">helm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iac/" rel="tag">iac</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ipapk/" rel="tag">ipapk</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/" rel="tag">k8s</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubebuilder/" rel="tag">kubebuilder</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/" rel="tag">leetcode</a><span class="tag-list-count">32</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/perf/" rel="tag">perf</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pgsql/" rel="tag">pgsql</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rabbitmq/" rel="tag">rabbitmq</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sse/" rel="tag">sse</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/" rel="tag">函数式编程</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="tag">正则表达式</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" rel="tag">消息队列</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%85%BE%E8%AE%AF%E4%BA%91/" rel="tag">腾讯云</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%93%9D%E7%9B%BE/" rel="tag">蓝盾</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" rel="tag">负载均衡</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">二月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">十一月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">十月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">一月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">29</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a><span class="archive-list-count">5</span></li></ul></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Golang/">Golang</a></p><p class="item-title"><a href="/2024/02/18/golang/golang_archive_zip/" class="title">Golang archive/zip 问题排查小记</a></p><p class="item-date"><time datetime="2024-02-17T16:00:00.000Z" itemprop="datePublished">2024-02-18</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2023/11/30/cloudnative/argocd_sse/" class="title">Argo CD 消息推送之 SSE</a></p><p class="item-date"><time datetime="2023-11-29T16:00:00.000Z" itemprop="datePublished">2023-11-30</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/CloudNative/">CloudNative</a></p><p class="item-title"><a href="/2023/10/25/cloudnative/argocd_webhook/" class="title">Argo CD 源码解析之自动同步</a></p><p class="item-date"><time datetime="2023-10-24T16:00:00.000Z" itemprop="datePublished">2023-10-25</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2023/01/30/common/g6_tree_demo/" class="title">AntV G6 实现 k8s 资源拓扑图展示</a></p><p class="item-date"><time datetime="2023-01-29T16:00:00.000Z" itemprop="datePublished">2023-01-30</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Golang/">Golang</a></p><p class="item-title"><a href="/2023/01/12/golang/golang_pb/" class="title">Protocol Buffers 学习笔记</a></p><p class="item-date"><time datetime="2023-01-11T16:00:00.000Z" itemprop="datePublished">2023-01-12</time></p></div></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><nav id="toc" class="article-toc"><h3 class="toc-title">文章目录</h3><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Overview"><span class="toc-number">1.</span> <span class="toc-text">Overview</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Get-Started"><span class="toc-number">2.</span> <span class="toc-text">Get Started</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Requirements"><span class="toc-number">2.1.</span> <span class="toc-text">Requirements</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Building-The-Provider"><span class="toc-number">2.2.</span> <span class="toc-text">Building The Provider</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Generate-the-Provider-Documentation"><span class="toc-number">2.3.</span> <span class="toc-text">Generate the Provider Documentation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Acceptance-tests"><span class="toc-number">2.4.</span> <span class="toc-text">Acceptance tests</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Directory-Structure"><span class="toc-number">2.5.</span> <span class="toc-text">Directory Structure</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Explore-your-development-environment"><span class="toc-number">2.6.</span> <span class="toc-text">Explore your development environment</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Define-provider-schema"><span class="toc-number">2.7.</span> <span class="toc-text">Define provider schema</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Define-bucket-data-resource-schema"><span class="toc-number">2.8.</span> <span class="toc-text">Define bucket data resource schema</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Implement-Complex-Read"><span class="toc-number">2.9.</span> <span class="toc-text">Implement Complex Read</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Implement-Create"><span class="toc-number">2.10.</span> <span class="toc-text">Implement Create</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Implement-Update"><span class="toc-number">2.11.</span> <span class="toc-text">Implement Update</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Implement-Delete"><span class="toc-number">2.12.</span> <span class="toc-text">Implement Delete</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Implement-Cos-Bucket-Service"><span class="toc-number">2.13.</span> <span class="toc-text">Implement Cos Bucket Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Test-the-provider"><span class="toc-number">2.14.</span> <span class="toc-text">Test the provider</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reference-documentation"><span class="toc-number">3.</span> <span class="toc-text">Reference documentation</span></a></li></ol></nav></div></aside><main class="main" role="main"><div class="content"><article id="post-cloudnative/terraform-plugins" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">Terraform Plugin Development</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2021/12/29/cloudnative/terraform-plugins/" class="article-date"><time datetime="2021-12-28T16:00:00.000Z" itemprop="datePublished">2021-12-29</time></a></span> <span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/CloudNative/">CloudNative</a></span> <span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link" href="/tags/iac/" rel="tag">iac</a></span> <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/12/29/cloudnative/terraform-plugins/#comments" class="article-comment-link">评论</a></span></div></div><div class="article-entry marked-body" itemprop="articleBody"><p>Terraform is an open source resource orchestration tool based on Golang, which allows users to manage and configure any infrastructure, the infrastructure of public and private cloud services, and external services.</p><a id="more"></a><h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p>Terraform is logically split into two main parts:</p><ul><li><strong>Terraform Core</strong>: This is the Terraform binary that communicates with plugins to manage infrastructure resources. It provides a common interface that allows you to leverage many different cloud providers, databases, services, and in-house solutions.</li><li><strong>Terraform Plugins</strong>: These are executable binaries written in Go that communicate with Terraform Core over an RPC interface. Each plugin exposes an implementation for a specific service, such as the <a href="https://registry.terraform.io/providers/hashicorp/aws/latest" target="_blank" rel="noopener">AWS provider</a> or the <a href="https://registry.terraform.io/providers/hashicorp/cloudinit/latest/docs" target="_blank" rel="noopener">cloud-init provider</a>. Terraform currently supports one type of Plugin called <a href="https://www.terraform.io/language/providers" target="_blank" rel="noopener">providers</a>.<br></li></ul><p><img src="/2021/12/29/cloudnative/terraform-plugins/terraform-plugin-overview.png" alt></p><h3 id="Get-Started"><a href="#Get-Started" class="headerlink" title="Get Started"></a>Get Started</h3><p>Clone these template repositories on GitHub: <a href="https://github.com/hashicorp/terraform-provider-scaffolding" target="_blank" rel="noopener">terraform-provider-scaffolding (SDKv2)</a></p><p>Steps:</p><ol><li>clone the <a href="https://github.com/hashicorp/terraform-provider-scaffolding" target="_blank" rel="noopener">terraform-provider-scaffolding (SDKv2)</a>.</li><li>explore development environment, modify <code>GNUmakefile</code>.</li><li>define the provider、data_source、resource schema.</li><li>write code for cos bucket CRUD (<code>internal/provider</code> dir) and acceptance tests.</li><li>test the provider.</li><li>generate the provider documentation.</li></ol><h4 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements"></a>Requirements</h4><ul><li>Terraform &gt;= 0.13.x</li><li>Go &gt;= 1.15</li></ul><h4 id="Building-The-Provider"><a href="#Building-The-Provider" class="headerlink" title="Building The Provider"></a>Building The Provider</h4><p>To compile the provider, run <code>go install</code>. This will build the provider and put the provider binary in the <code>$GOPATH/bin</code> directory.</p><h4 id="Generate-the-Provider-Documentation"><a href="#Generate-the-Provider-Documentation" class="headerlink" title="Generate the Provider Documentation"></a>Generate the Provider Documentation</h4><p>To generate or update documentation, run <code>go generate</code>.</p><h4 id="Acceptance-tests"><a href="#Acceptance-tests" class="headerlink" title="Acceptance tests"></a>Acceptance tests</h4><p>In order to run the full suite of Acceptance tests, run <code>make testacc</code>.</p><blockquote><p>Note: Acceptance tests create real resources, and often cost money to run.</p></blockquote><h4 id="Directory-Structure"><a href="#Directory-Structure" class="headerlink" title="Directory Structure"></a>Directory Structure</h4><p>Take <code>cos bucket</code> as an example, modify the directory structure as follows.</p><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">terraform-provider-cos</span></span><br><span class="line">├── <span class="selector-tag">README</span><span class="selector-class">.md</span>     </span><br><span class="line">├── <span class="selector-tag">GNUmakefile</span></span><br><span class="line">├── <span class="selector-tag">CHANGELOG</span><span class="selector-class">.md</span>                                变更日志</span><br><span class="line">├── <span class="selector-tag">LICENSE</span>                                     授权信息   </span><br><span class="line">├── <span class="selector-tag">main</span><span class="selector-class">.go</span>                                     程序入口文件</span><br><span class="line">├── <span class="selector-tag">docs</span>                                        文档目录</span><br><span class="line">├── <span class="selector-tag">examples</span>                                    示例配置文件目录</span><br><span class="line">├── <span class="selector-tag">internal</span>                                    <span class="selector-tag">Provider</span>核心目录</span><br><span class="line">│   └── <span class="selector-tag">provider</span></span><br><span class="line">│       ├── <span class="selector-tag">data_source_cos_bucket</span><span class="selector-class">.go</span>           <span class="selector-tag">bucket</span>查询</span><br><span class="line">│       ├── <span class="selector-tag">data_source_cos_bucket_test</span><span class="selector-class">.go</span></span><br><span class="line">│       ├── <span class="selector-tag">provider</span><span class="selector-class">.go</span>                         <span class="selector-tag">Provider</span>核心文件</span><br><span class="line">│       ├── <span class="selector-tag">provider_test</span><span class="selector-class">.go</span> </span><br><span class="line">│       ├── <span class="selector-tag">resource_cos_bucket</span><span class="selector-class">.go</span>              <span class="selector-tag">bucket</span>资源管理</span><br><span class="line">│       ├── <span class="selector-tag">resource_cos_bucket_test</span><span class="selector-class">.go</span></span><br><span class="line">│       └── <span class="selector-tag">service_cos_bucket</span><span class="selector-class">.go</span>               封装的<span class="selector-tag">bucket</span>相关<span class="selector-tag">Service</span></span><br><span class="line">├── <span class="selector-tag">go</span><span class="selector-class">.mod</span></span><br><span class="line">├── <span class="selector-tag">go</span><span class="selector-class">.sum</span></span><br><span class="line">├── <span class="selector-tag">terraform-registry-manifest</span><span class="selector-class">.json</span></span><br><span class="line">└── <span class="selector-tag">tools</span></span><br><span class="line">    └── <span class="selector-tag">tools</span><span class="selector-class">.go</span></span><br></pre></td></tr></table></figure><p>The structure is mainly divided into five parts:</p><ul><li><code>main.go</code>, plugin entry.</li><li><code>provider.go</code>, attributes used to describe plugins, such as: configured key, supported resource list, callback - configuration.</li><li><code>data_source_*.go</code>, read calls, mainly query interfaces.</li><li><code>resource_*.go</code>, write calls, including resource addition, deletion, modification and query interfaces.</li><li><code>service_*.go</code>, public methods divided by resource categories.</li></ul><h4 id="Explore-your-development-environment"><a href="#Explore-your-development-environment" class="headerlink" title="Explore your development environment"></a>Explore your development environment</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">TEST?=$<span class="variable">$(go list ./... | grep -v 'vendor')</span></span><br><span class="line">HOSTNAME=blazehu.com</span><br><span class="line">NAMESPACE=edu</span><br><span class="line">NAME=cos</span><br><span class="line">BINARY=terraform-provider-$&#123;NAME&#125;_v$&#123;VERSION&#125;</span><br><span class="line">OS_ARCH=darwin_amd64</span><br><span class="line">VERSION=0.1</span><br><span class="line"><span class="comment">#BINARY=terraform-provider-$&#123;NAME&#125;_v$&#123;VERSION&#125;.exe</span></span><br><span class="line"><span class="comment">#OS_ARCH=windows_amd64</span></span><br><span class="line"><span class="section">default: testacc</span></span><br><span class="line"></span><br><span class="line"><span class="section">build:</span></span><br><span class="line">	go build -o $&#123;BINARY&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">test:</span></span><br><span class="line">	go test -i <span class="variable">$(TEST)</span> || exit 1</span><br><span class="line">	echo <span class="variable">$(TEST)</span> | xargs -t -n4 go test <span class="variable">$(TESTARGS)</span> -timeout=30s -parallel=4</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run acceptance tests</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: testacc</span></span><br><span class="line"><span class="section">testacc:</span></span><br><span class="line">	TF_ACC=1 go test ./... -v <span class="variable">$(TESTARGS)</span> -timeout 120m</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: install</span></span><br><span class="line"><span class="section">install: build # Build manager binary.</span></span><br><span class="line">	mkdir -p ~/.terraform.d/plugins/$&#123;HOSTNAME&#125;/$&#123;NAMESPACE&#125;/$&#123;NAME&#125;/$&#123;VERSION&#125;/$&#123;OS_ARCH&#125;</span><br><span class="line">	mv $&#123;BINARY&#125; ~/.terraform.d/plugins/$&#123;HOSTNAME&#125;/$&#123;NAMESPACE&#125;/$&#123;NAME&#125;/$&#123;VERSION&#125;/$&#123;OS_ARCH&#125;</span><br></pre></td></tr></table></figure><h4 id="Define-provider-schema"><a href="#Define-provider-schema" class="headerlink" title="Define provider schema"></a>Define provider schema</h4><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(version <span class="keyword">string</span>)</span> <span class="title">func</span><span class="params">()</span> *<span class="title">schema</span>.<span class="title">Provider</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">()</span> *<span class="title">schema</span>.<span class="title">Provider</span></span> &#123;</span><br><span class="line">		p := &amp;schema.Provider&#123;</span><br><span class="line">			DataSourcesMap: <span class="keyword">map</span>[<span class="keyword">string</span>]*schema.Resource&#123;</span><br><span class="line">				<span class="string">"cos_bucket_data_source"</span>: dataSourceCosBucket(),</span><br><span class="line">			&#125;,</span><br><span class="line">			ResourcesMap: <span class="keyword">map</span>[<span class="keyword">string</span>]*schema.Resource&#123;</span><br><span class="line">				<span class="string">"cos_bucket_resource"</span>: resourceCosBucket(),</span><br><span class="line">			&#125;,</span><br><span class="line">			Schema: <span class="keyword">map</span>[<span class="keyword">string</span>]*schema.Schema&#123;</span><br><span class="line">				<span class="string">"secret_id"</span>: &amp;schema.Schema&#123;</span><br><span class="line">					Type:        schema.TypeString,</span><br><span class="line">					Required:    <span class="literal">true</span>,</span><br><span class="line">					Sensitive:   <span class="literal">true</span>,</span><br><span class="line">					DefaultFunc: schema.EnvDefaultFunc(<span class="string">"SECRET_ID"</span>, <span class="literal">nil</span>),</span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="string">"secret_key"</span>: &amp;schema.Schema&#123;</span><br><span class="line">					Type:        schema.TypeString,</span><br><span class="line">					Required:    <span class="literal">true</span>,</span><br><span class="line">					Sensitive:   <span class="literal">true</span>,</span><br><span class="line">					DefaultFunc: schema.EnvDefaultFunc(<span class="string">"SECRET_KEY"</span>, <span class="literal">nil</span>),</span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="string">"region"</span>: &amp;schema.Schema&#123;</span><br><span class="line">					Type:        schema.TypeString,</span><br><span class="line">					Required:    <span class="literal">true</span>,</span><br><span class="line">					Sensitive:   <span class="literal">true</span>,</span><br><span class="line">					DefaultFunc: schema.EnvDefaultFunc(<span class="string">"REGION"</span>, <span class="literal">nil</span>),</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">			ConfigureContextFunc: providerConfigure,</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> p</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">providerConfigure</span><span class="params">(ctx context.Context, d *schema.ResourceData)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, diag.Diagnostics)</span></span> &#123;</span><br><span class="line">	region := d.Get(<span class="string">"region"</span>).(<span class="keyword">string</span>)</span><br><span class="line">	secretId := d.Get(<span class="string">"secret_id"</span>).(<span class="keyword">string</span>)</span><br><span class="line">	secretKey := d.Get(<span class="string">"secret_key"</span>).(<span class="keyword">string</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Warning or errors can be collected in a slice type</span></span><br><span class="line">	<span class="keyword">var</span> diags diag.Diagnostics</span><br><span class="line"></span><br><span class="line">	c := &amp;CosClient&#123;</span><br><span class="line">		Region:    region,</span><br><span class="line">		SecretId:  secretId,</span><br><span class="line">		SecretKey: secretKey,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> c, diags</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Define-bucket-data-resource-schema"><a href="#Define-bucket-data-resource-schema" class="headerlink" title="Define bucket data resource schema"></a>Define bucket data resource schema</h4><p><code>resource_cos_bucket.go</code></p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">resourceCosBucket</span><span class="params">()</span> *<span class="title">schema</span>.<span class="title">Resource</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;schema.Resource&#123;</span><br><span class="line">		<span class="comment">// This description is used by the documentation generator and the language server.</span></span><br><span class="line">		Description: <span class="string">"Sample resource in the Terraform provider cos."</span>,</span><br><span class="line"></span><br><span class="line">		CreateContext: resourceCosBucketCreate,</span><br><span class="line">		ReadContext:   resourceCosBucketRead,</span><br><span class="line">		UpdateContext: resourceCosBucketUpdate,</span><br><span class="line">		DeleteContext: resourceCosBucketDelete,</span><br><span class="line"></span><br><span class="line">		Schema: <span class="keyword">map</span>[<span class="keyword">string</span>]*schema.Schema&#123;</span><br><span class="line">			<span class="string">"name"</span>: &#123;</span><br><span class="line">				<span class="comment">// This description is used by the documentation generator and the language server.</span></span><br><span class="line">				Description: <span class="string">"cos bucket name."</span>,</span><br><span class="line">				Type:        schema.TypeString,</span><br><span class="line">				Required:    <span class="literal">true</span>,</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">"acl"</span>: &#123;</span><br><span class="line">				Description: <span class="string">"cos bucket acl."</span>,</span><br><span class="line">				Type:        schema.TypeString,</span><br><span class="line">				Default:     <span class="string">"private"</span>,</span><br><span class="line">				Optional:    <span class="literal">true</span>,</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">"update_at"</span>: &#123;</span><br><span class="line">				Description: <span class="string">"cos bucket create time"</span>,</span><br><span class="line">				Type:        schema.TypeString,</span><br><span class="line">				Computed:    <span class="literal">true</span>,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>data_source_cos_bucket.go</code></p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dataSourceCosBucket</span><span class="params">()</span> *<span class="title">schema</span>.<span class="title">Resource</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;schema.Resource&#123;</span><br><span class="line">		<span class="comment">// This description is used by the documentation generator and the language server.</span></span><br><span class="line">		Description: <span class="string">"Sample data source in the Terraform provider cos."</span>,</span><br><span class="line"></span><br><span class="line">		ReadContext: dataSourceCosBucketRead,</span><br><span class="line"></span><br><span class="line">		Schema: <span class="keyword">map</span>[<span class="keyword">string</span>]*schema.Schema&#123;</span><br><span class="line">			<span class="string">"name"</span>: &#123;</span><br><span class="line">				<span class="comment">// This description is used by the documentation generator and the language server.</span></span><br><span class="line">				Description: <span class="string">"cos bucket name."</span>,</span><br><span class="line">				Type:        schema.TypeString,</span><br><span class="line">				Required:    <span class="literal">true</span>,</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">"owner"</span>: &#123;</span><br><span class="line">				<span class="comment">// This description is used by the documentation generator and the language server.</span></span><br><span class="line">				Description: <span class="string">"cos bucket owner."</span>,</span><br><span class="line">				Type:        schema.TypeString,</span><br><span class="line">				Computed:    <span class="literal">true</span>,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Implement-Complex-Read"><a href="#Implement-Complex-Read" class="headerlink" title="Implement Complex Read"></a>Implement Complex Read</h4><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dataSourceCosBucketRead</span><span class="params">(ctx context.Context, d *schema.ResourceData, meta <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">diag</span>.<span class="title">Diagnostics</span></span> &#123;</span><br><span class="line">	<span class="comment">// use the meta value to retrieve your client from the provider configure method</span></span><br><span class="line">	client := meta.(*CosClient)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> diags diag.Diagnostics</span><br><span class="line"></span><br><span class="line">	name := d.Get(<span class="string">"name"</span>).(<span class="keyword">string</span>)</span><br><span class="line">	owner, err := client.GetACLOwner(name)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> diag.Errorf(fmt.Sprintf(<span class="string">"get cos bucket owner failed. msg: %s"</span>, err.Error()))</span><br><span class="line">	&#125;</span><br><span class="line">	d.SetId(name)</span><br><span class="line">	<span class="keyword">if</span> err = d.Set(<span class="string">"owner"</span>, owner); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		tflog.Error(ctx, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> diags</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Implement-Create"><a href="#Implement-Create" class="headerlink" title="Implement Create"></a>Implement Create</h4><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">resourceCosBucketCreate</span><span class="params">(ctx context.Context, d *schema.ResourceData, meta <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">diag</span>.<span class="title">Diagnostics</span></span> &#123;</span><br><span class="line">	<span class="comment">// use the meta value to retrieve your client from the provider configure method</span></span><br><span class="line">	client := meta.(*CosClient)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> diags diag.Diagnostics</span><br><span class="line"></span><br><span class="line">	name := d.Get(<span class="string">"name"</span>).(<span class="keyword">string</span>)</span><br><span class="line">	acl := d.Get(<span class="string">"acl"</span>).(<span class="keyword">string</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := client.Put(name, acl); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> diag.Errorf(fmt.Sprintf(<span class="string">"created cos bucket failed. msg: %s"</span>, err.Error()))</span><br><span class="line">	&#125;</span><br><span class="line">	d.SetId(name)</span><br><span class="line">	<span class="keyword">if</span> err := d.Set(<span class="string">"update_at"</span>, time.Now().Format(time.RFC3339)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		tflog.Error(ctx, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tflog.Info(ctx, fmt.Sprintf(<span class="string">"created a cos bucket, name: %s, region: %s"</span>, name, client.Region))</span><br><span class="line">	<span class="comment">// write logs using the tflog package</span></span><br><span class="line">	<span class="comment">// see https://pkg.go.dev/github.com/hashicorp/terraform-plugin-log/tflog</span></span><br><span class="line">	<span class="comment">// for more information</span></span><br><span class="line">	<span class="keyword">return</span> diags</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Implement-Update"><a href="#Implement-Update" class="headerlink" title="Implement Update"></a>Implement Update</h4><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">resourceCosBucketUpdate</span><span class="params">(ctx context.Context, d *schema.ResourceData, meta <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">diag</span>.<span class="title">Diagnostics</span></span> &#123;</span><br><span class="line">	<span class="comment">// use the meta value to retrieve your client from the provider configure method</span></span><br><span class="line">	client := meta.(*CosClient)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> diags diag.Diagnostics</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> d.HasChange(<span class="string">"acl"</span>) &#123;</span><br><span class="line">		name := d.Get(<span class="string">"name"</span>).(<span class="keyword">string</span>)</span><br><span class="line">		acl := d.Get(<span class="string">"acl"</span>).(<span class="keyword">string</span>)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err := client.PutACL(name, acl); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> diag.Errorf(fmt.Sprintf(<span class="string">"update cos bucket acl failed. msg: %s"</span>, err.Error()))</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err := d.Set(<span class="string">"update_at"</span>, time.Now().Format(time.RFC3339)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			tflog.Error(ctx, err.Error())</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> diags</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Implement-Delete"><a href="#Implement-Delete" class="headerlink" title="Implement Delete"></a>Implement Delete</h4><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">resourceCosBucketDelete</span><span class="params">(ctx context.Context, d *schema.ResourceData, meta <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">diag</span>.<span class="title">Diagnostics</span></span> &#123;</span><br><span class="line">	<span class="comment">// use the meta value to retrieve your client from the provider configure method</span></span><br><span class="line">	client := meta.(*CosClient)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> diags diag.Diagnostics</span><br><span class="line"></span><br><span class="line">	name := d.Get(<span class="string">"name"</span>).(<span class="keyword">string</span>)</span><br><span class="line">	<span class="keyword">if</span> err := client.Delete(name); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> diag.Errorf(fmt.Sprintf(<span class="string">"delete cos bucket failed. msg: %s"</span>, err.Error()))</span><br><span class="line">	&#125;</span><br><span class="line">	d.SetId(<span class="string">""</span>)</span><br><span class="line">	tflog.Info(ctx, fmt.Sprintf(<span class="string">"delete a cos bucket, name: %s"</span>, name))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> diags</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Implement-Cos-Bucket-Service"><a href="#Implement-Cos-Bucket-Service" class="headerlink" title="Implement Cos Bucket Service"></a>Implement Cos Bucket Service</h4><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"github.com/tencentyun/cos-go-sdk-v5"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"net/url"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CosClient <span class="keyword">struct</span> &#123;</span><br><span class="line">	SecretId  <span class="keyword">string</span></span><br><span class="line">	SecretKey <span class="keyword">string</span></span><br><span class="line">	Region    <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *CosClient)</span> <span class="title">client</span><span class="params">(name <span class="keyword">string</span>)</span> *<span class="title">cos</span>.<span class="title">Client</span></span> &#123;</span><br><span class="line">	url, _ := url.Parse(fmt.Sprintf(<span class="string">"https://%s.cos.%s.myqcloud.com"</span>, name, c.Region))</span><br><span class="line">	b := &amp;cos.BaseURL&#123;BucketURL: url&#125;</span><br><span class="line">	<span class="keyword">return</span> cos.NewClient(b, &amp;http.Client&#123;</span><br><span class="line">		Transport: &amp;cos.AuthorizationTransport&#123;</span><br><span class="line">			SecretID:  c.SecretId,</span><br><span class="line">			SecretKey: c.SecretKey,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *CosClient)</span> <span class="title">Put</span><span class="params">(name, acl <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	opt := &amp;cos.BucketPutOptions&#123;</span><br><span class="line">		XCosACL: acl,</span><br><span class="line">	&#125;</span><br><span class="line">	_, err := c.client(name).Bucket.Put(context.Background(), opt)</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *CosClient)</span> <span class="title">GetACLOwner</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	acl, _, err := c.client(name).Bucket.GetACL(context.Background())</span><br><span class="line">	<span class="keyword">return</span> acl.Owner.DisplayName, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *CosClient)</span> <span class="title">PutACL</span><span class="params">(name, acl <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	opt := &amp;cos.BucketPutACLOptions&#123;</span><br><span class="line">		Header: &amp;cos.ACLHeaderOptions&#123;</span><br><span class="line">			<span class="comment">//private，public-read，public-read-write</span></span><br><span class="line">			XCosACL: acl,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	_, err := c.client(name).Bucket.PutACL(context.Background(), opt)</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *CosClient)</span> <span class="title">Delete</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	_, err := c.client(name).Bucket.Delete(context.Background())</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Test-the-provider"><a href="#Test-the-provider" class="headerlink" title="Test the provider"></a>Test the provider</h4><ol><li><code>make install</code><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[blazehu@MacBook ~]$ make install</span><br><span class="line">go build -o terraform-provider-cos_v0.1</span><br><span class="line">mkdir -p ~/.terraform.d/plugins/blazehu.com/edu/cos/0.1/darwin_amd64</span><br><span class="line">mv terraform-provider-cos_v0.1 ~/.terraform.d/plugins/blazehu.com/edu/cos/0.1/darwin_amd64</span><br></pre></td></tr></table></figure></li><li>write <code>demo.tf</code><figure class="highlight tcl"><table><tr><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    cos = &#123;</span><br><span class="line">      <span class="keyword">source</span>  = <span class="string">"blazehu.com/edu/cos"</span></span><br><span class="line">      version = <span class="string">"0.1"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider <span class="string">"cos"</span> &#123;</span><br><span class="line">  region = <span class="string">"ap-shanghai"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">"cos_bucket_resource"</span> <span class="string">"demo"</span> &#123;</span><br><span class="line">  name = <span class="string">"terraform-1251762279"</span></span><br><span class="line">  acl  = <span class="string">"private"</span></span><br><span class="line"><span class="comment">  # acl = "public-read-write"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data <span class="string">"cos_bucket_data_source"</span> <span class="string">"test"</span> &#123;</span><br><span class="line">  name = cos_bucket_resource.demo.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>run <code>terraform init</code><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Initializing the backend...</span><br><span class="line"></span><br><span class="line">Initializing provider plugins...</span><br><span class="line">- Finding blazehu.com/edu/cos versions matching <span class="string">"0.1.0"</span>...</span><br><span class="line">- Installing blazehu.com/edu/cos v0.1.0...</span><br><span class="line">- Installed blazehu.com/edu/cos v0.1.0 (unauthenticated)</span><br><span class="line"></span><br><span class="line">Terraform has created a lock file .terraform.lock.hcl to record the provider</span><br><span class="line">selections it made above. Include this file <span class="keyword">in</span> your version control repository</span><br><span class="line">so that Terraform can guarantee to make the same selections by default when</span><br><span class="line">you run <span class="string">"terraform init"</span> <span class="keyword">in</span> the future.</span><br><span class="line"></span><br><span class="line">Terraform has been successfully initialized!</span><br></pre></td></tr></table></figure></li><li>run <code>terraform apply -auto-approve</code>, create a cos bucket<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:</span><br><span class="line">  + create</span><br><span class="line"> &lt;= <span class="built_in">read</span> (data resources)</span><br><span class="line"></span><br><span class="line">Terraform will perform the following actions:</span><br><span class="line"></span><br><span class="line">  <span class="comment"># data.cos_bucket_data_source.test will be read during apply</span></span><br><span class="line">  <span class="comment"># (config refers to values not yet known)</span></span><br><span class="line"> &lt;= data <span class="string">"cos_bucket_data_source"</span> <span class="string">"test"</span>  &#123;</span><br><span class="line">      + id    = (known after apply)</span><br><span class="line">      + name  = (known after apply)</span><br><span class="line">      + owner = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># cos_bucket_resource.demo will be created</span></span><br><span class="line">  + resource <span class="string">"cos_bucket_resource"</span> <span class="string">"demo"</span> &#123;</span><br><span class="line">      + acl       = <span class="string">"public-read-write"</span></span><br><span class="line">      + id        = (known after apply)</span><br><span class="line">      + name      = <span class="string">"terraform-1251762279"</span></span><br><span class="line">      + update_at = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 1 to add, 0 to change, 0 to destroy.</span><br><span class="line">cos_bucket_resource.demo: Creating...</span><br><span class="line">cos_bucket_resource.demo: Creation complete after 1s [id=terraform-1251762279]</span><br><span class="line">data.cos_bucket_data_source.test: Reading...</span><br><span class="line">data.cos_bucket_data_source.test: Read complete after 0s [id=terraform-1251762279]</span><br><span class="line"></span><br><span class="line">Apply complete! Resources: 1 added, 0 changed, 0 destroyed.</span><br></pre></td></tr></table></figure></li><li>change acl to <code>public-read-write</code>, run <code>terraform apply -auto-approve</code><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cos_bucket_resource.demo: Refreshing state... [id=terraform-1251762279]</span><br><span class="line"></span><br><span class="line">Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:</span><br><span class="line">  ~ update <span class="keyword">in</span>-place</span><br><span class="line"> &lt;= <span class="built_in">read</span> (data resources)</span><br><span class="line"></span><br><span class="line">Terraform will perform the following actions:</span><br><span class="line"></span><br><span class="line">  <span class="comment"># data.cos_bucket_data_source.test will be read during apply</span></span><br><span class="line">  <span class="comment"># (config refers to values not yet known)</span></span><br><span class="line"> &lt;= data <span class="string">"cos_bucket_data_source"</span> <span class="string">"test"</span>  &#123;</span><br><span class="line">      ~ id    = <span class="string">"terraform-1251762279"</span> -&gt; (known after apply)</span><br><span class="line">        name  = <span class="string">"terraform-1251762279"</span></span><br><span class="line">      ~ owner = <span class="string">"qcs::cam::uin/794369159:uin/794369159"</span> -&gt; (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># cos_bucket_resource.demo will be updated in-place</span></span><br><span class="line">  ~ resource <span class="string">"cos_bucket_resource"</span> <span class="string">"demo"</span> &#123;</span><br><span class="line">      ~ acl       = <span class="string">"public-read-write"</span> -&gt; <span class="string">"private"</span></span><br><span class="line">        id        = <span class="string">"terraform-1251762279"</span></span><br><span class="line">        name      = <span class="string">"terraform-1251762279"</span></span><br><span class="line">        <span class="comment"># (1 unchanged attribute hidden)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 0 to add, 1 to change, 0 to destroy.</span><br><span class="line">cos_bucket_resource.demo: Modifying... [id=terraform-1251762279]</span><br><span class="line">cos_bucket_resource.demo: Modifications complete after 1s [id=terraform-1251762279]</span><br><span class="line">data.cos_bucket_data_source.test: Reading... [id=terraform-1251762279]</span><br><span class="line">data.cos_bucket_data_source.test: Read complete after 0s [id=terraform-1251762279]</span><br><span class="line"></span><br><span class="line">Apply complete! Resources: 0 added, 1 changed, 0 destroyed.</span><br></pre></td></tr></table></figure></li><li>verify if no changes, run <code>terraform apply -auto-approve</code><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cos_bucket_resource.demo: Refreshing state... [id=terraform-1251762279]</span><br><span class="line"></span><br><span class="line">No changes. Your infrastructure matches the configuration.</span><br><span class="line"></span><br><span class="line">Terraform has compared your real infrastructure against your configuration and found no differences, so no changes are needed.</span><br><span class="line"></span><br><span class="line">Apply complete! Resources: 0 added, 0 changed, 0 destroyed.</span><br></pre></td></tr></table></figure></li><li>destroy the resources, run <code>terraform destroy -auto-approve</code><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cos_bucket_resource.demo: Refreshing state... [id=terraform-1251762279]</span><br><span class="line"></span><br><span class="line">Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:</span><br><span class="line">  - destroy</span><br><span class="line"></span><br><span class="line">Terraform will perform the following actions:</span><br><span class="line"></span><br><span class="line">  <span class="comment"># cos_bucket_resource.demo will be destroyed</span></span><br><span class="line">  - resource <span class="string">"cos_bucket_resource"</span> <span class="string">"demo"</span> &#123;</span><br><span class="line">      - acl       = <span class="string">"private"</span> -&gt; null</span><br><span class="line">      - id        = <span class="string">"terraform-1251762279"</span> -&gt; null</span><br><span class="line">      - name      = <span class="string">"terraform-1251762279"</span> -&gt; null</span><br><span class="line">      - update_at = <span class="string">"2022-01-29T11:28:31+08:00"</span> -&gt; null</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 0 to add, 0 to change, 1 to destroy.</span><br><span class="line">cos_bucket_resource.demo: Destroying... [id=terraform-1251762279]</span><br><span class="line">cos_bucket_resource.demo: Destruction complete after 1s</span><br><span class="line"></span><br><span class="line">Destroy complete! Resources: 1 destroyed.</span><br></pre></td></tr></table></figure><blockquote><p>Tip: You can also retrieve detailed Terraform and provider logs by setting the environment variable TF_LOG. Please include a detailed logs with any bug reports so the author can identify and address the bug. To learn more about log levels and how to interpret a crash log, refer to the <a href="https://www.terraform.io/internals/debugging" target="_blank" rel="noopener">Debugging Terraform Documentation</a>.</p></blockquote></li></ol><h3 id="Reference-documentation"><a href="#Reference-documentation" class="headerlink" title="Reference documentation"></a>Reference documentation</h3><ul><li><a href="https://www.terraform.io/plugin" target="_blank" rel="noopener">https://www.terraform.io/plugin</a></li><li><a href="https://learn.hashicorp.com/collections/terraform/providers" target="_blank" rel="noopener">https://learn.hashicorp.com/collections/terraform/providers</a></li><li><a href="https://cloud.tencent.com/developer/article/1067230" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1067230</a></li></ul></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="https://blazehu.github.io/2021/12/29/cloudnative/terraform-plugins/" title="Terraform Plugin Development" target="_blank" rel="external">https://blazehu.github.io/2021/12/29/cloudnative/terraform-plugins/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://github.com/blazehu" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/avatar.png" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="https://github.com/blazehu" target="_blank"><span class="text-dark">blazehu</span><small class="ml-1x">CloudNative/SRE/DevOps</small></a></h3><div>个人简介。</div></div></figure></div></div></div></article><section id="comments"><div id="vcomments"></div></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2022/03/11/cloudnative/terraform-controller/" title="Terraform Controller Practices"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a></li><li class="next"><a href="/2021/12/05/cloudnative/terraform/" title="Terraform Best Practices"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li><li class="toggle-toc"><a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button"><span>[&nbsp;</span><span>文章目录</span> <i class="text-collapsed icon icon-anchor"></i> <i class="text-in icon icon-close"></i> <span>]</span></a></li></ul><button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div></div></div></nav><div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content donate"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><div class="modal-body"><div class="donate-box"><div class="donate-head"><p>感谢您的支持，我会继续努力的!</p></div><div class="tab-content"><div role="tabpanel" class="tab-pane fade active in" id="alipay"><div class="donate-payimg"><img src="/images/blazehu/alipayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p></div><div role="tabpanel" class="tab-pane fade" id="wechatpay"><div class="donate-payimg"><img src="/images/blazehu/wechatpayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p></div></div><div class="donate-footer"><ul class="nav nav-tabs nav-justified" role="tablist"><li role="presentation" class="active"><a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a></li><li role="presentation"><a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a></li></ul></div></div></div></div></div></div></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/blazehu" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div class="copyright"><div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine"></script><script type="text/javascript">var GUEST=["nick","mail","link"],meta=(meta="nick,mail,link").split(",").filter(function(e){return-1<GUEST.indexOf(e)});new Valine({el:"#vcomments",verify:!1,notify:!1,appId:"kXQOrkmTyCVLtqQoMTpVJPWK-gzGzoHsz",appKey:"yEbFaNQxvOxdDX4N65dhbrkq",placeholder:"Just go go",avatar:"mm",meta:meta,pageSize:"10",visitor:!1})</script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px;z-index:2}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>addLoadEvent(()=>{$(".highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code")[0].innerText;e+="",e+=`————————————————
`,e+=`本文链接：${window.location.href}
`,e+="版权声明： 本博客所有文章除特别声明外，均采用 CC BY 4.0 CN协议 许可协议。转载请注明出处！";var n=document.createElement("textarea");document.body.appendChild(n),n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.value=e,n.select(),n.focus(),e=document.execCommand("copy"),document.body.removeChild(n),e?$(this).text("复制成功"):$(this).text("复制失败"),$(this).blur()})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})})</script></body></html>